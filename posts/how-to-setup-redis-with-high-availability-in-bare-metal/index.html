<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Setup Redis With High Availability in Bare Metal | Book of Daniel</title>
<meta name=keywords content><meta name=description content="Redis is an open-source, in-memory key-value store known for its high performance and versatility. It operates primarily as a cache or a quick-response database, storing data in memory to enable low-latency read and write operations. Redis supports various data structures, including strings, lists, sets, and hashes, making it suitable for a wide range of applications from caching to real-time analytics. Its design allows for rapid data access and manipulation, which is crucial for applications requiring high throughput and low latency."><meta name=author content="Dan"><link rel=canonical href=https://bookofdaniel.in/posts/how-to-setup-redis-with-high-availability-in-bare-metal/><meta name=google-site-verification content="G-VXV565Z72E"><link crossorigin=anonymous href=/assets/css/stylesheet.1f0036bedfbca8c1b3e62402134309ab28bb8ed2563fe55b73ee7f604993f240.css integrity="sha256-HwA2vt+8qMGz5iQCE0MJqyi7jtJWP+Vbc+5/YEmT8kA=" rel="preload stylesheet" as=style><link rel=icon href=https://bookofdaniel.in/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://bookofdaniel.in/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://bookofdaniel.in/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://bookofdaniel.in/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://bookofdaniel.in/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bookofdaniel.in/posts/how-to-setup-redis-with-high-availability-in-bare-metal/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-VXV565Z72E"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VXV565Z72E")}</script><meta property="og:title" content="How to Setup Redis With High Availability in Bare Metal"><meta property="og:description" content="Redis is an open-source, in-memory key-value store known for its high performance and versatility. It operates primarily as a cache or a quick-response database, storing data in memory to enable low-latency read and write operations. Redis supports various data structures, including strings, lists, sets, and hashes, making it suitable for a wide range of applications from caching to real-time analytics. Its design allows for rapid data access and manipulation, which is crucial for applications requiring high throughput and low latency."><meta property="og:type" content="article"><meta property="og:url" content="https://bookofdaniel.in/posts/how-to-setup-redis-with-high-availability-in-bare-metal/"><meta property="og:image" content="https://bookofdaniel.in/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-21T11:26:36+05:30"><meta property="article:modified_time" content="2025-01-21T11:26:36+05:30"><meta property="og:site_name" content="Book of Daniel"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bookofdaniel.in/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="How to Setup Redis With High Availability in Bare Metal"><meta name=twitter:description content="Redis is an open-source, in-memory key-value store known for its high performance and versatility. It operates primarily as a cache or a quick-response database, storing data in memory to enable low-latency read and write operations. Redis supports various data structures, including strings, lists, sets, and hashes, making it suitable for a wide range of applications from caching to real-time analytics. Its design allows for rapid data access and manipulation, which is crucial for applications requiring high throughput and low latency."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bookofdaniel.in/posts/"},{"@type":"ListItem","position":2,"name":"How to Setup Redis With High Availability in Bare Metal","item":"https://bookofdaniel.in/posts/how-to-setup-redis-with-high-availability-in-bare-metal/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Setup Redis With High Availability in Bare Metal","name":"How to Setup Redis With High Availability in Bare Metal","description":"Redis is an open-source, in-memory key-value store known for its high performance and versatility. It operates primarily as a cache or a quick-response database, storing data in memory to enable low-latency read and write operations. Redis supports various data structures, including strings, lists, sets, and hashes, making it suitable for a wide range of applications from caching to real-time analytics. Its design allows for rapid data access and manipulation, which is crucial for applications requiring high throughput and low latency.\n","keywords":[],"articleBody":"Redis is an open-source, in-memory key-value store known for its high performance and versatility. It operates primarily as a cache or a quick-response database, storing data in memory to enable low-latency read and write operations. Redis supports various data structures, including strings, lists, sets, and hashes, making it suitable for a wide range of applications from caching to real-time analytics. Its design allows for rapid data access and manipulation, which is crucial for applications requiring high throughput and low latency.\nHigh Availability Architecture (Sentinel) To enhance reliability and availability, Redis can be paired with Redis Sentinel, a system designed to monitor Redis instances and manage failover processes. Sentinel provides automated monitoring of master and slave instances, ensuring that if the master fails, a slave can be promoted to master without manual intervention. This architecture allows applications to maintain continuous operation even in the face of server failures.Key features of Redis Sentinel include:\nMonitoring: Sentinel continuously checks the health of master and slave instances.\nAutomatic Failover: In case of a master failure, Sentinel automatically promotes a slave to become the new master.\nConfiguration Management: It updates clients with the new master information, allowing them to reconnect seamlessly.\nTogether, Redis and Sentinel create a robust architecture that ensures high availability and resilience, making it an ideal choice for applications that require constant uptime and reliable data access.\nHow to Setup To set up Redis with Sentinel on every machine for high availability, follow these detailed steps. This guide assumes you have three Linux servers ready, each running Redis and Sentinel.\nStep 1: Install Redis On all three servers, install Redis using the following commands:\n1 2 sudo apt-get update sudo apt-get install redis-server Step 2: Configure Redis Instances Server Configuration Overview Server 1 (Master): Runs Redis as the master. Server 2 (Replica): Runs Redis as a replica of Server 1. Server 3 (Replica): Runs Redis as a replica of Server 1. On Server 1 (Master) Edit the Redis configuration file located at /etc/redis/redis.conf:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Allow external connections bind 0.0.0.0 # Set a password for replication requirepass your_master_password # Enable protected mode protected-mode no sed -i 's/^bind 127.0.0.1/bind 0.0.0.0/' /etc/redis/redis.conf sed -i 's/^protected-mode yes/protected-mode no/' /etc/redis/redis.conf sed -i \"s/# requirepass foobared/requirepass /\" /etc/redis/redis.conf sed -i -E 's/^#?\\s*masterauth.*/masterauth your_password_here/' /etc/redis/redis.conf # only in replica node sed -i -E 's/^#?\\s*replicaof\\s+\\s+/replicaof new_server_ip 6379/' redis.conf On Server 2 (Replica) Edit the Redis configuration file on Server 2:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Allow external connections bind 0.0.0.0 # Set a password for replication requirepass your_master_password # Enable protected mode protected-mode no # Configure as a replica of Server 1 replicaof 6379 # Set the master user for replication masterauth your_master_password sed -i -E 's/^#?\\s*masterauth.*/masterauth your_password_here/' /etc/redis/redis.conf sed -i -E 's/^#?\\s*replicaof\\s+\\s+/replicaof new_server_ip new_port/' redis.conf On Server 3 (Replica) Repeat the same configuration as on Server 2, but point to Server 1’s IP address.\nStep 3: Configure Sentinel on Each Server Create a Sentinel configuration file on each server. Here’s how to do it:\nOn All Servers (Sentinel Configuration) Create a file named sentinel.conf at /etc/redis/sentinel.conf:\n1 2 3 4 5 6 7 port 26379 bind 0.0.0.0 sentinel monitor mymaster 6379 2 sentinel down-after-milliseconds mymaster 5000 sentinel failover-timeout mymaster 60000 sentinel auth-pass mymaster your_master_password Make sure to replace with the actual IP address of your master server.\nChange permission of file to redis user\n1 chown redis:redis /etc/redis/sentinel.conf Step 4: Start Redis and Sentinel Services Start Sentinel Instances You can start the Sentinel service using the following command on each server:\n1 redis-server /etc/redis/sentinel.conf --sentinel To run this command in the background, you may want to create a systemd service for Sentinel:\nCreate a new service file at /etc/systemd/system/redis-sentinel.service:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [Unit] Description=Redis Sentinel After=network.target [Service] User=redis Group=redis Type=simple ExecStart=/usr/bin/redis-server /etc/redis/sentinel.conf --sentinel ExecStop=/usr/bin/redis-cli -p 26379 shutdown Restart=always [Install] WantedBy=multi-user.target Then enable and start the Sentinel service:\n1 2 3 sudo systemctl daemon-reload sudo systemctl enable redis-sentinel.service sudo systemctl start redis-sentinel.service Start Redis Instances On each server, start the Redis service:\n1 2 sudo systemctl restart redis-server sudo systemctl enable redis-server Step 5: Verify Setup To check if everything is working correctly, connect to one of the Sentinels:\n1 redis-cli -p 26379 SENTINEL masters This command should return information about the monitored master instance.\nRedis client Sender 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 import redis from redis.sentinel import Sentinel import time # Define the Sentinel connection details sentinels = [('10.211.11.7', 26379), ('10.211.11.8', 26379), ('10.211.11.9', 26379)] password = 'S7WubxPy8ZoPhuTS5bgttw' def get_master(): \"\"\"Get the current master Redis instance from Sentinel.\"\"\" while True: try: sentinel = Sentinel(sentinels, socket_timeout=0.1) master = sentinel.master_for('mymaster', password=password) return master except (redis.ConnectionError, redis.TimeoutError) as e: print(f\"Error connecting to Sentinel: {e}. Retrying in 5 seconds...\") time.sleep(5) # Wait before retrying def main(): \"\"\"Main function to increment a value in Redis continuously.\"\"\" while True: # Run indefinitely until stopped master = get_master() # Get the master instance # Log the master node's address master_address = master.connection_pool.get_connection('SET').host master_port = master.connection_pool.get_connection('SET').port print(f\"Connected to Redis node at {master_address}:{master_port}\") value = 0 # Initialize the value for INCR while True: # Continuously attempt to set the value try: value += 1 # Increment the value master.set('INCR', value) # Store the incremented value in Redis under 'INCR' print(f'Set INCR = {value} in Redis node at {master_address}:{master_port}') # Print confirmation with node info time.sleep(1) # Sleep for 1 second before next increment except (redis.ConnectionError, redis.TimeoutError) as e: print(f\"Connection error occurred: {e}. Re-fetching master...\") break # Break to re-fetch master on connection error # Handle re-fetching of the master after an error while True: try: master = get_master() # Attempt to get a new master master_address = master.connection_pool.get_connection('SET').host master_port = master.connection_pool.get_connection('SET').port print(f\"Connected to new Redis node at {master_address}:{master_port}\") break # Exit this loop if successful except Exception as e: print(f\"Failed to connect to new master: {e}. Retrying in 5 seconds...\") time.sleep(5) # Wait before retrying if __name__ == \"__main__\": main() Receive 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 import redis from redis.sentinel import Sentinel import time # Define the Sentinel connection details sentinels = [('10.211.11.7', 26379), ('10.211.11.8', 26379), ('10.211.11.9', 26379)] password = 'S7WubxPy8ZoPhuTS5bgttw' def get_master(): \"\"\"Get the current master Redis instance from Sentinel.\"\"\" while True: for sentinel_address in sentinels: try: sentinel = Sentinel([sentinel_address], socket_timeout=0.1) master = sentinel.master_for('mymaster', password=password) return master except (redis.ConnectionError, redis.TimeoutError) as e: print(f\"Error connecting to Sentinel at {sentinel_address}: {e}. Trying next sentinel...\") time.sleep(1) # Short wait before trying next sentinel print(\"All sentinels are unreachable. Retrying in 5 seconds...\") time.sleep(5) # Wait before retrying all sentinels def main(): while True: # Run indefinitely until stopped master = get_master() # Get the master instance # Get the master node's address for logging master_address = master.connection_pool.get_connection('GET').host master_port = master.connection_pool.get_connection('GET').port print(f\"Connected to Redis node at {master_address}:{master_port}\") while True: # Run indefinitely until stopped try: # Fetch the value of the 'INCR' key from Redis value = master.get('INCR') # Decode the value if it is not None if value is not None: value = int(value) print(f'Retrieved INCR = {value} from Redis node at {master_address}:{master_port}') time.sleep(1) # Sleep for 1 second before the next iteration except (redis.ConnectionError, redis.TimeoutError) as e: print(f\"Connection error occurred: {e}. Re-fetching master...\") break # Break to re-fetch master on connection error # Handle re-fetching of the master after an error while True: try: master = get_master() # Attempt to get a new master master_address = master.connection_pool.get_connection('GET').host master_port = master.connection_pool.get_connection('GET').port print(f\"Connected to new Redis node at {master_address}:{master_port}\") break # Exit this loop if successful except Exception as e: print(f\"Failed to connect to new master: {e}. Retrying all sentinels in 5 seconds...\") time.sleep(5) # Wait before retrying if __name__ == \"__main__\": main() Conclusion With this setup, each server runs both a Redis instance and a Sentinel instance, providing high availability through monitoring and automatic failover capabilities. This configuration allows for redundancy and ensures that if one server goes down, others can take over seamlessly. Always ensure that your passwords are strong and consider additional security measures based on your environment’s needs.\nCitations:\n[1] https://redis.io/learn/operate/redis-at-scale/high-availability/exercise-2 [2] https://redis.io/docs/latest/operate/oss_and_stack/management/sentinel/ [3] https://docs.servicestack.net/redis/sentinel [4] https://facsiaginsa.com/redis/setup-redis-ha-using-sentinel [5] https://dev.to/hedgehog/set-up-a-redis-sentinel-3m50 [6] https://github.com/ServiceStack/redis-config [7] https://stackoverflow.com/questions/53284461/redis-sentinel-with-only-one-host ","wordCount":"1479","inLanguage":"en","image":"https://bookofdaniel.in/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-01-21T11:26:36+05:30","dateModified":"2025-01-21T11:26:36+05:30","author":[{"@type":"Person","name":"Dan"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://bookofdaniel.in/posts/how-to-setup-redis-with-high-availability-in-bare-metal/"},"publisher":{"@type":"Organization","name":"Book of Daniel","logo":{"@type":"ImageObject","url":"https://bookofdaniel.in/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bookofdaniel.in/ accesskey=h title="Book of Daniel (Alt + H)">Book of Daniel</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bookofdaniel.in/posts/ title=Blog><span>Blog</span></a></li><li><a href=https://bookofdaniel.in/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bookofdaniel.in/>Home</a>&nbsp;»&nbsp;<a href=https://bookofdaniel.in/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">How to Setup Redis With High Availability in Bare Metal</h1><div class=post-meta><span title='2025-01-21 11:26:36 +0530 +0530'>January 21, 2025</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1479 words&nbsp;·&nbsp;Dan</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#high-availability-architecture-sentinel aria-label="High Availability Architecture (Sentinel)">High Availability Architecture (Sentinel)</a></li><li><a href=#how-to-setup aria-label="How to Setup">How to Setup</a></li><li><a href=#step-1-install-redis aria-label="Step 1: Install Redis">Step 1: Install Redis</a></li><li><a href=#step-2-configure-redis-instances aria-label="Step 2: Configure Redis Instances">Step 2: Configure Redis Instances</a><ul><li><a href=#server-configuration-overview aria-label="Server Configuration Overview">Server Configuration Overview</a></li><li><a href=#on-server-1-master aria-label="On Server 1 (Master)">On Server 1 (Master)</a></li><li><a href=#on-server-2-replica aria-label="On Server 2 (Replica)">On Server 2 (Replica)</a></li><li><a href=#on-server-3-replica aria-label="On Server 3 (Replica)">On Server 3 (Replica)</a></li></ul></li><li><a href=#step-3-configure-sentinel-on-each-server aria-label="Step 3: Configure Sentinel on Each Server">Step 3: Configure Sentinel on Each Server</a><ul><li><a href=#on-all-servers-sentinel-configuration aria-label="On All Servers (Sentinel Configuration)">On All Servers (Sentinel Configuration)</a></li></ul></li><li><a href=#step-4-start-redis-and-sentinel-services aria-label="Step 4: Start Redis and Sentinel Services">Step 4: Start Redis and Sentinel Services</a><ul><li><a href=#start-sentinel-instances aria-label="Start Sentinel Instances">Start Sentinel Instances</a></li><li><a href=#start-redis-instances aria-label="Start Redis Instances">Start Redis Instances</a></li></ul></li><li><a href=#step-5-verify-setup aria-label="Step 5: Verify Setup">Step 5: Verify Setup</a><ul><ul><li><a href=#redis-client aria-label="Redis client">Redis client</a></li></ul><li><a href=#sender aria-label=Sender>Sender</a></li><li><a href=#receive aria-label=Receive>Receive</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>Redis is an open-source, in-memory key-value store known for its high performance and versatility. It operates primarily as a cache or a quick-response database, storing data in memory to enable low-latency read and write operations. Redis supports various data structures, including strings, lists, sets, and hashes, making it suitable for a wide range of applications from caching to real-time analytics. Its design allows for rapid data access and manipulation, which is crucial for applications requiring high throughput and low latency.</p><h2 id=high-availability-architecture-sentinel>High Availability Architecture (Sentinel)<a hidden class=anchor aria-hidden=true href=#high-availability-architecture-sentinel>#</a></h2><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:875/0*VN8JCyjIRKtD7NFo.png alt></p><p>To enhance reliability and availability, Redis can be paired with Redis Sentinel, a system designed to monitor Redis instances and manage failover processes. Sentinel provides automated monitoring of master and slave instances, ensuring that if the master fails, a slave can be promoted to master without manual intervention. This architecture allows applications to maintain continuous operation even in the face of server failures.Key features of Redis Sentinel include:</p><ul><li><p>Monitoring: Sentinel continuously checks the health of master and slave instances.</p></li><li><p>Automatic Failover: In case of a master failure, Sentinel automatically promotes a slave to become the new master.</p></li><li><p>Configuration Management: It updates clients with the new master information, allowing them to reconnect seamlessly.</p></li></ul><p>Together, Redis and Sentinel create a robust architecture that ensures high availability and resilience, making it an ideal choice for applications that require constant uptime and reliable data access.</p><h2 id=how-to-setup>How to Setup<a hidden class=anchor aria-hidden=true href=#how-to-setup>#</a></h2><p>To set up Redis with Sentinel on every machine for high availability, follow these detailed steps. This guide assumes you have three Linux servers ready, each running Redis and Sentinel.</p><h2 id=step-1-install-redis>Step 1: Install Redis<a hidden class=anchor aria-hidden=true href=#step-1-install-redis>#</a></h2><p>On all three servers, install Redis using the following commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get update
</span></span><span class=line><span class=cl>sudo apt-get install redis-server
</span></span></code></pre></td></tr></table></div></div><h2 id=step-2-configure-redis-instances>Step 2: Configure Redis Instances<a hidden class=anchor aria-hidden=true href=#step-2-configure-redis-instances>#</a></h2><h3 id=server-configuration-overview>Server Configuration Overview<a hidden class=anchor aria-hidden=true href=#server-configuration-overview>#</a></h3><ul><li>Server 1 (Master): Runs Redis as the master.</li><li>Server 2 (Replica): Runs Redis as a replica of Server 1.</li><li>Server 3 (Replica): Runs Redis as a replica of Server 1.</li></ul><h3 id=on-server-1-master>On Server 1 (Master)<a hidden class=anchor aria-hidden=true href=#on-server-1-master>#</a></h3><p>Edit the Redis configuration file located at <code>/etc/redis/redis.conf</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Allow external connections</span>
</span></span><span class=line><span class=cl><span class=nb>bind</span> 0.0.0.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set a password for replication</span>
</span></span><span class=line><span class=cl>requirepass your_master_password
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Enable protected mode</span>
</span></span><span class=line><span class=cl>protected-mode no
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/^bind 127.0.0.1/bind 0.0.0.0/&#39;</span> /etc/redis/redis.conf
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/^protected-mode yes/protected-mode no/&#39;</span> /etc/redis/redis.conf
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s/# requirepass foobared/requirepass &lt;your_password&gt;/&#34;</span> /etc/redis/redis.conf
</span></span><span class=line><span class=cl>sed -i -E <span class=s1>&#39;s/^#?\s*masterauth.*/masterauth your_password_here/&#39;</span> /etc/redis/redis.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># only in replica node</span>
</span></span><span class=line><span class=cl>sed -i -E <span class=s1>&#39;s/^#?\s*replicaof\s+&lt;masterip&gt;\s+&lt;masterport&gt;/replicaof new_server_ip 6379/&#39;</span> redis.conf
</span></span></code></pre></td></tr></table></div></div><h3 id=on-server-2-replica>On Server 2 (Replica)<a hidden class=anchor aria-hidden=true href=#on-server-2-replica>#</a></h3><p>Edit the Redis configuration file on Server 2:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Allow external connections</span>
</span></span><span class=line><span class=cl><span class=nb>bind</span> 0.0.0.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set a password for replication</span>
</span></span><span class=line><span class=cl>requirepass your_master_password
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Enable protected mode</span>
</span></span><span class=line><span class=cl>protected-mode no
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Configure as a replica of Server 1</span>
</span></span><span class=line><span class=cl>replicaof &lt;Server_1_IP&gt; <span class=m>6379</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the master user for replication</span>
</span></span><span class=line><span class=cl>masterauth your_master_password
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i -E <span class=s1>&#39;s/^#?\s*masterauth.*/masterauth your_password_here/&#39;</span> /etc/redis/redis.conf
</span></span><span class=line><span class=cl>sed -i -E <span class=s1>&#39;s/^#?\s*replicaof\s+&lt;masterip&gt;\s+&lt;masterport&gt;/replicaof new_server_ip new_port/&#39;</span> redis.conf
</span></span></code></pre></td></tr></table></div></div><h3 id=on-server-3-replica>On Server 3 (Replica)<a hidden class=anchor aria-hidden=true href=#on-server-3-replica>#</a></h3><p>Repeat the same configuration as on Server 2, but point to Server 1&rsquo;s IP address.</p><h2 id=step-3-configure-sentinel-on-each-server>Step 3: Configure Sentinel on Each Server<a hidden class=anchor aria-hidden=true href=#step-3-configure-sentinel-on-each-server>#</a></h2><p>Create a Sentinel configuration file on each server. Here’s how to do it:</p><h3 id=on-all-servers-sentinel-configuration>On All Servers (Sentinel Configuration)<a hidden class=anchor aria-hidden=true href=#on-all-servers-sentinel-configuration>#</a></h3><p>Create a file named <code>sentinel.conf</code> at <code>/etc/redis/sentinel.conf</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>port <span class=m>26379</span>
</span></span><span class=line><span class=cl><span class=nb>bind</span> 0.0.0.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sentinel monitor mymaster &lt;Server_1_IP&gt; <span class=m>6379</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>sentinel down-after-milliseconds mymaster <span class=m>5000</span>
</span></span><span class=line><span class=cl>sentinel failover-timeout mymaster <span class=m>60000</span>
</span></span><span class=line><span class=cl>sentinel auth-pass mymaster your_master_password
</span></span></code></pre></td></tr></table></div></div><p>Make sure to replace <code>&lt;Server_1_IP></code> with the actual IP address of your master server.</p><p>Change permission of file to <code>redis</code> user</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chown redis:redis /etc/redis/sentinel.conf
</span></span></code></pre></td></tr></table></div></div><h2 id=step-4-start-redis-and-sentinel-services>Step 4: Start Redis and Sentinel Services<a hidden class=anchor aria-hidden=true href=#step-4-start-redis-and-sentinel-services>#</a></h2><h3 id=start-sentinel-instances>Start Sentinel Instances<a hidden class=anchor aria-hidden=true href=#start-sentinel-instances>#</a></h3><p>You can start the Sentinel service using the following command on each server:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>redis-server /etc/redis/sentinel.conf --sentinel
</span></span></code></pre></td></tr></table></div></div><p>To run this command in the background, you may want to create a systemd service for Sentinel:</p><p>Create a new service file at <code>/etc/systemd/system/redis-sentinel.service</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>	<span class=k>[Unit]</span>
</span></span><span class=line><span class=cl>	<span class=na>Description</span><span class=o>=</span><span class=s>Redis Sentinel
</span></span></span><span class=line><span class=cl><span class=s>	After=network.target</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>[Service]</span>
</span></span><span class=line><span class=cl>	<span class=na>User</span><span class=o>=</span><span class=s>redis
</span></span></span><span class=line><span class=cl><span class=s>	Group=redis
</span></span></span><span class=line><span class=cl><span class=s>	Type=simple
</span></span></span><span class=line><span class=cl><span class=s>	ExecStart=/usr/bin/redis-server /etc/redis/sentinel.conf --sentinel
</span></span></span><span class=line><span class=cl><span class=s>	ExecStop=/usr/bin/redis-cli -p 26379 shutdown
</span></span></span><span class=line><span class=cl><span class=s>	Restart=always</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>[Install]</span>
</span></span><span class=line><span class=cl>	<span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></td></tr></table></div></div><p>Then enable and start the Sentinel service:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>	sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>	sudo systemctl <span class=nb>enable</span> redis-sentinel.service
</span></span><span class=line><span class=cl>	sudo systemctl start redis-sentinel.service
</span></span></code></pre></td></tr></table></div></div><h3 id=start-redis-instances>Start Redis Instances<a hidden class=anchor aria-hidden=true href=#start-redis-instances>#</a></h3><p>On each server, start the Redis service:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>	sudo systemctl restart redis-server
</span></span><span class=line><span class=cl>	sudo systemctl <span class=nb>enable</span> redis-server
</span></span></code></pre></td></tr></table></div></div><h2 id=step-5-verify-setup>Step 5: Verify Setup<a hidden class=anchor aria-hidden=true href=#step-5-verify-setup>#</a></h2><p>To check if everything is working correctly, connect to one of the Sentinels:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>	redis-cli -p <span class=m>26379</span> SENTINEL masters
</span></span></code></pre></td></tr></table></div></div><p>This command should return information about the monitored master instance.</p><h4 id=redis-client>Redis client<a hidden class=anchor aria-hidden=true href=#redis-client>#</a></h4><h3 id=sender>Sender<a hidden class=anchor aria-hidden=true href=#sender>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>	<span class=kn>from</span> <span class=nn>redis.sentinel</span> <span class=kn>import</span> <span class=n>Sentinel</span>
</span></span><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># Define the Sentinel connection details</span>
</span></span><span class=line><span class=cl>	<span class=n>sentinels</span> <span class=o>=</span> <span class=p>[(</span><span class=s1>&#39;10.211.11.7&#39;</span><span class=p>,</span> <span class=mi>26379</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;10.211.11.8&#39;</span><span class=p>,</span> <span class=mi>26379</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;10.211.11.9&#39;</span><span class=p>,</span> <span class=mi>26379</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>	<span class=n>password</span> <span class=o>=</span> <span class=s1>&#39;S7WubxPy8ZoPhuTS5bgttw&#39;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>get_master</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	    <span class=s2>&#34;&#34;&#34;Get the current master Redis instance from Sentinel.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>	    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	            <span class=n>sentinel</span> <span class=o>=</span> <span class=n>Sentinel</span><span class=p>(</span><span class=n>sentinels</span><span class=p>,</span> <span class=n>socket_timeout</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	            <span class=n>master</span> <span class=o>=</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>master_for</span><span class=p>(</span><span class=s1>&#39;mymaster&#39;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	            <span class=k>return</span> <span class=n>master</span>
</span></span><span class=line><span class=cl>	        <span class=k>except</span> <span class=p>(</span><span class=n>redis</span><span class=o>.</span><span class=n>ConnectionError</span><span class=p>,</span> <span class=n>redis</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error connecting to Sentinel: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>. Retrying in 5 seconds...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># Wait before retrying</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	    <span class=s2>&#34;&#34;&#34;Main function to increment a value in Redis continuously.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>	    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>  <span class=c1># Run indefinitely until stopped</span>
</span></span><span class=line><span class=cl>	        <span class=n>master</span> <span class=o>=</span> <span class=n>get_master</span><span class=p>()</span>  <span class=c1># Get the master instance</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=c1># Log the master node&#39;s address</span>
</span></span><span class=line><span class=cl>	        <span class=n>master_address</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;SET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>host</span>
</span></span><span class=line><span class=cl>	        <span class=n>master_port</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;SET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>port</span>
</span></span><span class=line><span class=cl>	        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Connected to Redis node at </span><span class=si>{</span><span class=n>master_address</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>master_port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=n>value</span> <span class=o>=</span> <span class=mi>0</span>  <span class=c1># Initialize the value for INCR</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>  <span class=c1># Continuously attempt to set the value</span>
</span></span><span class=line><span class=cl>	            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=n>value</span> <span class=o>+=</span> <span class=mi>1</span>  <span class=c1># Increment the value</span>
</span></span><span class=line><span class=cl>	                <span class=n>master</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=s1>&#39;INCR&#39;</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>  <span class=c1># Store the incremented value in Redis under &#39;INCR&#39;</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Set INCR = </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1> in Redis node at </span><span class=si>{</span><span class=n>master_address</span><span class=si>}</span><span class=s1>:</span><span class=si>{</span><span class=n>master_port</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># Print confirmation with node info</span>
</span></span><span class=line><span class=cl>	                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># Sleep for 1 second before next increment</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	            <span class=k>except</span> <span class=p>(</span><span class=n>redis</span><span class=o>.</span><span class=n>ConnectionError</span><span class=p>,</span> <span class=n>redis</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Connection error occurred: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>. Re-fetching master...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=k>break</span>  <span class=c1># Break to re-fetch master on connection error</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=c1># Handle re-fetching of the master after an error</span>
</span></span><span class=line><span class=cl>	        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=n>master</span> <span class=o>=</span> <span class=n>get_master</span><span class=p>()</span>  <span class=c1># Attempt to get a new master</span>
</span></span><span class=line><span class=cl>	                <span class=n>master_address</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;SET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>host</span>
</span></span><span class=line><span class=cl>	                <span class=n>master_port</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;SET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>port</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Connected to new Redis node at </span><span class=si>{</span><span class=n>master_address</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>master_port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=k>break</span>  <span class=c1># Exit this loop if successful</span>
</span></span><span class=line><span class=cl>	            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to connect to new master: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>. Retrying in 5 seconds...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># Wait before retrying</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	    <span class=n>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	
</span></span></code></pre></td></tr></table></div></div><h3 id=receive>Receive<a hidden class=anchor aria-hidden=true href=#receive>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>				  
</span></span><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>	<span class=kn>from</span> <span class=nn>redis.sentinel</span> <span class=kn>import</span> <span class=n>Sentinel</span>
</span></span><span class=line><span class=cl>	<span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># Define the Sentinel connection details</span>
</span></span><span class=line><span class=cl>	<span class=n>sentinels</span> <span class=o>=</span> <span class=p>[(</span><span class=s1>&#39;10.211.11.7&#39;</span><span class=p>,</span> <span class=mi>26379</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;10.211.11.8&#39;</span><span class=p>,</span> <span class=mi>26379</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;10.211.11.9&#39;</span><span class=p>,</span> <span class=mi>26379</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>	<span class=n>password</span> <span class=o>=</span> <span class=s1>&#39;S7WubxPy8ZoPhuTS5bgttw&#39;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>get_master</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	    <span class=s2>&#34;&#34;&#34;Get the current master Redis instance from Sentinel.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>	    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	        <span class=k>for</span> <span class=n>sentinel_address</span> <span class=ow>in</span> <span class=n>sentinels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=n>sentinel</span> <span class=o>=</span> <span class=n>Sentinel</span><span class=p>([</span><span class=n>sentinel_address</span><span class=p>],</span> <span class=n>socket_timeout</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=n>master</span> <span class=o>=</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>master_for</span><span class=p>(</span><span class=s1>&#39;mymaster&#39;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=k>return</span> <span class=n>master</span>
</span></span><span class=line><span class=cl>	            <span class=k>except</span> <span class=p>(</span><span class=n>redis</span><span class=o>.</span><span class=n>ConnectionError</span><span class=p>,</span> <span class=n>redis</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error connecting to Sentinel at </span><span class=si>{</span><span class=n>sentinel_address</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>. Trying next sentinel...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># Short wait before trying next sentinel</span>
</span></span><span class=line><span class=cl>	        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;All sentinels are unreachable. Retrying in 5 seconds...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># Wait before retrying all sentinels</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>  <span class=c1># Run indefinitely until stopped</span>
</span></span><span class=line><span class=cl>	        <span class=n>master</span> <span class=o>=</span> <span class=n>get_master</span><span class=p>()</span>  <span class=c1># Get the master instance</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=c1># Get the master node&#39;s address for logging</span>
</span></span><span class=line><span class=cl>	        <span class=n>master_address</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>host</span>
</span></span><span class=line><span class=cl>	        <span class=n>master_port</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>port</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Connected to Redis node at </span><span class=si>{</span><span class=n>master_address</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>master_port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>  <span class=c1># Run indefinitely until stopped</span>
</span></span><span class=line><span class=cl>	            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=c1># Fetch the value of the &#39;INCR&#39; key from Redis</span>
</span></span><span class=line><span class=cl>	                <span class=n>value</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;INCR&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	                <span class=c1># Decode the value if it is not None</span>
</span></span><span class=line><span class=cl>	                <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                    <span class=n>value</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Retrieved INCR = </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1> from Redis node at </span><span class=si>{</span><span class=n>master_address</span><span class=si>}</span><span class=s1>:</span><span class=si>{</span><span class=n>master_port</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># Sleep for 1 second before the next iteration</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	            <span class=k>except</span> <span class=p>(</span><span class=n>redis</span><span class=o>.</span><span class=n>ConnectionError</span><span class=p>,</span> <span class=n>redis</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Connection error occurred: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>. Re-fetching master...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=k>break</span>  <span class=c1># Break to re-fetch master on connection error</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	        <span class=c1># Handle re-fetching of the master after an error</span>
</span></span><span class=line><span class=cl>	        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=n>master</span> <span class=o>=</span> <span class=n>get_master</span><span class=p>()</span>  <span class=c1># Attempt to get a new master</span>
</span></span><span class=line><span class=cl>	                <span class=n>master_address</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>host</span>
</span></span><span class=line><span class=cl>	                <span class=n>master_port</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>port</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Connected to new Redis node at </span><span class=si>{</span><span class=n>master_address</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>master_port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=k>break</span>  <span class=c1># Exit this loop if successful</span>
</span></span><span class=line><span class=cl>	            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to connect to new master: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>. Retrying all sentinels in 5 seconds...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># Wait before retrying</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	    <span class=n>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	
</span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>With this setup, each server runs both a Redis instance and a Sentinel instance, providing high availability through monitoring and automatic failover capabilities. This configuration allows for redundancy and ensures that if one server goes down, others can take over seamlessly. Always ensure that your passwords are strong and consider additional security measures based on your environment&rsquo;s needs.</p><p><strong>Citations</strong>:</p><ul><li>[1] <a href=https://redis.io/learn/operate/redis-at-scale/high-availability/exercise-2>https://redis.io/learn/operate/redis-at-scale/high-availability/exercise-2</a></li><li>[2] <a href=https://redis.io/docs/latest/operate/oss_and_stack/management/sentinel/>https://redis.io/docs/latest/operate/oss_and_stack/management/sentinel/</a></li><li>[3] <a href=https://docs.servicestack.net/redis/sentinel>https://docs.servicestack.net/redis/sentinel</a></li><li>[4] <a href=https://facsiaginsa.com/redis/setup-redis-ha-using-sentinel>https://facsiaginsa.com/redis/setup-redis-ha-using-sentinel</a></li><li>[5] <a href=https://dev.to/hedgehog/set-up-a-redis-sentinel-3m50>https://dev.to/hedgehog/set-up-a-redis-sentinel-3m50</a></li><li>[6] <a href=https://github.com/ServiceStack/redis-config>https://github.com/ServiceStack/redis-config</a></li><li>[7] <a href=https://stackoverflow.com/questions/53284461/redis-sentinel-with-only-one-host>https://stackoverflow.com/questions/53284461/redis-sentinel-with-only-one-host</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://bookofdaniel.in/posts/before-you-give-up/><span class=title>Next »</span><br><span>Before You Give Up</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=dannotes/bookofdaniel-comments data-repo-id=R_kgDOMwnsUw data-category=Comments data-category-id=DIC_kwDOMwnsU84CiaCW data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark data-lang=en crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://bookofdaniel.in/>Book of Daniel</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>